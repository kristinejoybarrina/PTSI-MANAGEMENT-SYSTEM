<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Lab Result</title>
  <link rel="stylesheet" href="../assets/css/labresult_add_admin.css" />
  <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="https://philtbsociety.org/wp-content/uploads/2022/07/cropped-1-PTSI-New-Logo-Original-1-600x786.png" alt="PTSI Logo" class="logo" />
      <h2>PTSI</h2>
      <div class="sidebar-toggle" id="toggleSidebar">
        <img src="../assets/img/arrow-left.png" alt="Hide Sidebar" />
      </div>
    </div>
    <ul class="menu">
      <h3>Menu</h3>
      <li id="dashboard"><i class="icon"><img src="../assets/img/dash-icon.png" /></i><h3>Dashboard</h3></li>
      <li id="user-account"><i class="icon"><img src="../assets/img/account-icon.png" /></i><h3>User Account</h3></li>
      <li id="lab-result"><i class="icon"><img src="../assets/img/lab-result-icon.png" /></i><h3>Lab Result</h3></li>
      <li id="appointment"><i class="icon"><img src="../assets/img/appointment-icon.png" /></i><h3>Appointment</h3></li>
    </ul>
    <div class="logout" id="logout">
      <img src="../assets/img/logout-icon.png" alt="Logout Icon" />
      <h3>Logout</h3>
    </div>
  </div>

  <div class="main-content">
    <div class="header">
      <div class="header-left">
        <div class="hamburger" id="hamburger">
          <img src="../assets/img/hamburger-icon.png" alt="Menu" />
        </div>
        <div class="labresult-title"><strong>Add Lab Result</strong></div>
      </div>
      <div class="header-icons">
        <span><img src="../assets/img/notif-icon.png" alt="Notification Icon" /></span>
        <span><img src="../assets/img/profile-icon.png" alt="Profile Icon" /></span>
      </div>
    </div>

    <form id="addLabForm">
      <a href="lab_result_admin.html" class="back-icon">
        <img src="../assets/img/back-icon.png" alt="Back" />
      </a>
      <h1>Add Lab Result</h1>

      <label>Lab ID:
        <input type="text" id="labId" name="labId" readonly  />
      </label><br/>

      <label>First Name:
        <input type="text" id="firstName" name="firstName" readonly  />
      </label><br/>
      
    <label>Middle Name:
      <input type="text" id="middleName" name="middleName" readonly />
    </label><br/>
      
      <label>Last Name:
        <input type="text" id="lastName" name="lastName" readonly  />
      </label><br/>      

      <table id="labResultsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>File (PDF)</th>
          </tr>
        </thead>
        <tbody>
          <tr class="lab-result-entry">
            <td><input type="date" class="date" required /></td>
            <td><input type="text" class="type" required /></td>
            <td><input type="file" class="labFile" accept="application/pdf" /></td>
          </tr>
        </tbody>
      </table>
      
      <button type="button" id="addMoreBtn">+ Add Another Lab Result</button>
      

      <div class="form-button-container">
        <button type="submit">Add Lab Result</button>
      </div>
    </form>
  </div>

  <script src="../assets/js/menu.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyCMK2EIUDf_N5K4qfe2G214gAgctoUAp3Q",
      authDomain: "ptsi-system-293aa.firebaseapp.com",
      projectId: "ptsi-system-293aa",
      storageBucket: "ptsi-system-293aa.appspot.com",
      messagingSenderId: "229290736029",
      appId: "1:229290736029:web:da2246786b173fddcd1774"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const form = document.getElementById("addLabForm");
  
    window.onload = async () => {
        const patientId = localStorage.getItem("addLabForPatientId");
        if (patientId) {
          const patientRef = doc(db, "patientLab", patientId);
          const patientSnap = await getDoc(patientRef);
          if (patientSnap.exists()) {
            const data = patientSnap.data();
            form.labId.value = data.laboratoryId || "";
            form.firstName.value = data.firstName || "";
            form.middleName.value = data.middleName || "";
            form.lastName.value = data.lastName || "";
          } else {
            alert("Patient not found.");
          }
        }
      };
      
  
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
      
        const labId = form.labId.value;
        const fullName = `${form.firstName.value} ${form.middleName.value} ${form.lastName.value}`.trim().replace(/\s+/g, ' ');
      
        const userDocRef = doc(db, "users", labId);
        const labResultsRef = collection(userDocRef, "labResults");
      
        const rows = document.querySelectorAll(".lab-result-entry");
      
        try {
          for (const row of rows) {
            const date = row.querySelector(".date").value;
            const type = row.querySelector(".type").value;
            const fileInput = row.querySelector(".labFile");
      
            let pdfBase64 = null;
            if (fileInput.files.length > 0) {
              const file = fileInput.files[0];
              pdfBase64 = await toBase64(file);
            }
      
            const resultCode = "LR" + Math.floor(Math.random() * 100000);
      
            const newResult = {
              laboratoryId: labId,
              patientName: fullName,
              date,
              resultType: type,
              resultCode,
              lastUpdated: serverTimestamp(),
              pdfBase64
            };
      
            await addDoc(labResultsRef, newResult);
          }
      
          alert("All lab results added!");
          window.location.href = "lab_result_admin.html";
      
        } catch (err) {
          console.error("Error adding lab result:", err);
          alert("Failed to add lab result.");
        }
      });
      
  
    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    const tableBody = document.querySelector("#labResultsTable tbody");
    const addMoreBtn = document.getElementById("addMoreBtn");

    addMoreBtn.addEventListener("click", () => {
    const row = document.createElement("tr");
    row.classList.add("lab-result-entry");
    row.innerHTML = `
        <td><input type="date" class="date" required /></td>
        <td><input type="text" class="type" required /></td>
        <td><input type="file" class="labFile" accept="application/pdf" /></td>
    `;
    tableBody.appendChild(row);
    });

  </script>
  
</body>
</html>
