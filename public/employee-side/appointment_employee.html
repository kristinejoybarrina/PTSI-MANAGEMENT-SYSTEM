<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments - Employee</title>
    <link rel="stylesheet" href="../assets/css/appointment-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://philtbsociety.org/wp-content/uploads/2022/07/cropped-1-PTSI-New-Logo-Original-1-600x786.png" alt="PTSI Logo" class="logo">
            <h2>PTSI</h2>
            <div class="sidebar-toggle" id="toggleSidebar">
                <img src="../assets/img/arrow-left.png" alt="Hide Sidebar">
            </div>
        </div>
        <ul class="menu">
            <h3>Menu</h3>
            <li id="dashboard"><i class="icon"><img src="../assets/img/dash-icon.png"></i><h3>Dashboard</h3></li>
            <li id="lab-result"><i class="icon"><img src="../assets/img/lab-result-icon.png"></i><h3>Lab Result</h3></li>
            <li id="appointment" class="active"><i class="icon"><img src="../assets/img/appointment-icon.png"></i><h3>Appointment</h3></li>
        </ul>
        <div class="logout" id="logout">
            <img src="../assets/img/logout-icon.png" alt="Logout Icon">
            <h3>Logout</h3>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-left">
                <div class="hamburger" id="hamburger">
                    <img src="../assets/img/hamburger-icon.png" alt="Menu"/>
                </div>
                <div class="page-title"><strong>Appointments</strong></div>
            </div>
            <div class="header-right">
                <div class="search-bar">
                    <input type="text" id="searchAppointments" placeholder="Search appointments...">
                    <button><i class="fas fa-search"></i></button>
                </div>
                <div class="header-actions">
                    <button id="addAppointmentBtn" class="btn-primary">
                        <i class="fas fa-plus"></i> Add Appointment
                    </button>
                    <div class="user-profile">
                        <img src="../assets/img/default-avatar.png" alt="User">
                        <span id="employeeName">Employee</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="appointment-container">
            <div class="appointment-filters">
                <div class="filter-group">
                    <label for="statusFilter">Status:</label>
                    <select id="statusFilter">
                        <option value="all">All Appointments</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFilter">Date:</label>
                    <input type="date" id="dateFilter">
                </div>
                <button id="applyFilters" class="btn-secondary">Apply Filters</button>
                <button id="resetFilters" class="btn-text">Reset</button>
            </div>

            <div class="appointment-list">
                <div class="appointment-list-header">
                    <div class="appointment-id">ID</div>
                    <div class="appointment-patient">Patient</div>
                    <div class="appointment-date">Date & Time</div>
                    <div class="appointment-service">Service</div>
                    <div class="appointment-status">Status</div>
                    <div class="appointment-actions">Actions</div>
                </div>
                <div class="appointment-list-body" id="appointmentList">
                    <!-- Appointments will be loaded here by JavaScript -->
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Loading appointments...
                    </div>
                </div>
            </div>

            <div class="pagination">
                <button id="prevPage" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                <div class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
                <button id="nextPage" disabled>Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Appointment Modal -->
    <div class="modal" id="appointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Appointment</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <input type="hidden" id="appointmentId">
                    <div class="form-group">
                        <label for="patientSelect">Patient</label>
                        <select id="patientSelect" required>
                            <option value="">Select Patient</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointmentDate">Date</label>
                        <input type="date" id="appointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="appointmentTime">Time</label>
                        <input type="time" id="appointmentTime" required>
                    </div>
                    <div class="form-group">
                        <label for="serviceSelect">Service</label>
                        <select id="serviceSelect" required>
                            <option value="">Select Service</option>
                            <option value="consultation">Consultation</option>
                            <option value="follow-up">Follow-up</option>
                            <option value="lab-test">Lab Test</option>
                            <option value="vaccination">Vaccination</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointmentNotes">Notes</label>
                        <textarea id="appointmentNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="statusSelect">Status</label>
                        <select id="statusSelect" required>
                            <option value="scheduled">Scheduled</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancelAppointment">Cancel</button>
                        <button type="submit" class="btn-primary">Save Appointment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content confirm-modal">
            <div class="modal-body">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="confirmMessage">Are you sure you want to delete this appointment?</h3>
                <div class="confirm-actions">
                    <button class="btn-secondary" id="cancelConfirm">Cancel</button>
                    <button class="btn-danger" id="confirmAction">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMK2EIUDf_N5K4qfe2G214gAgctoUAp3Q",
            authDomain: "ptsi-system-293aa.firebaseapp.com",
            projectId: "ptsi-system-293aa",
            storageBucket: "ptsi-system-293aa.firebasestorage.app",
            messagingSenderId: "229290736029",
            appId: "1:229290736029:web:da2246786b173fddcd1774",
            measurementId: "G-2CEM231Z6K"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const toggleSidebar = document.getElementById('toggleSidebar');
        const hamburger = document.getElementById('hamburger');
        const logoutBtn = document.getElementById('logout');
        const addAppointmentBtn = document.getElementById('addAppointmentBtn');
        const appointmentForm = document.getElementById('appointmentForm');
        const appointmentModal = document.getElementById('appointmentModal');
        const confirmModal = document.getElementById('confirmModal');
        const closeModalBtns = document.querySelectorAll('.close-modal, #cancelAppointment, #cancelConfirm');
        const confirmActionBtn = document.getElementById('confirmAction');
        const searchInput = document.getElementById('searchAppointments');
        const statusFilter = document.getElementById('statusFilter');
        const dateFilter = document.getElementById('dateFilter');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const currentPageSpan = document.getElementById('currentPage');
        const totalPagesSpan = document.getElementById('totalPages');

        // State
        let appointments = [];
        let filteredAppointments = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let selectedAppointmentId = null;

        // Initialize the page
        function init() {
            setupEventListeners();
            loadAppointments();
            loadPatients();
            setCurrentUser();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation
            document.getElementById('dashboard').addEventListener('click', () => {
                window.location.href = 'dashboard_employee.html';
            });

            document.getElementById('lab-result').addEventListener('click', () => {
                window.location.href = 'lab_result_employee.html';
            });

            // Logout
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('isEmployee');
                localStorage.removeItem('loggedInUsername');
                localStorage.removeItem('employeeId');
                window.location.href = '../index.html';
            });

            // Toggle sidebar
            toggleSidebar.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                document.querySelector('.main-content').classList.toggle('expanded');
            });

            hamburger.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                document.querySelector('.main-content').classList.toggle('expanded');
            });

            // Add new appointment
            addAppointmentBtn.addEventListener('click', () => {
                openAppointmentModal();
            });

            // Close modals
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    appointmentModal.style.display = 'none';
                    confirmModal.style.display = 'none';
                });
            });

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === appointmentModal) {
                    appointmentModal.style.display = 'none';
                }
                if (e.target === confirmModal) {
                    confirmModal.style.display = 'none';
                }
            });

            // Form submission
            appointmentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveAppointment();
            });

            // Search
            searchInput.addEventListener('input', filterAppointments);
            applyFiltersBtn.addEventListener('click', filterAppointments);
            resetFiltersBtn.addEventListener('click', resetFilters);

            // Pagination
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderAppointments();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredAppointments.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderAppointments();
                }
            });
        }

        // Set current user info
        function setCurrentUser() {
            const username = localStorage.getItem('loggedInUsername');
            if (username) {
                document.getElementById('employeeName').textContent = username;
            }
        }

        // Load appointments from Firestore
        async function loadAppointments() {
            try {
                const querySnapshot = await db.collection('appointments')
                    .orderBy('date', 'desc')
                    .get();
                
                appointments = [];
                querySnapshot.forEach(doc => {
                    appointments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                filterAppointments();
            } catch (error) {
                console.error("Error loading appointments:", error);
                showNotification('Error loading appointments. Please try again.', 'error');
            }
        }

        // Load patients for the dropdown
        async function loadPatients() {
            try {
                const querySnapshot = await db.collection('registrationForm').get();
                const patientSelect = document.getElementById('patientSelect');
                
                // Clear existing options except the first one
                while (patientSelect.options.length > 1) {
                    patientSelect.remove(1);
                }
                
                querySnapshot.forEach(doc => {
                    const patient = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${patient.firstName || ''} ${patient.lastName || ''}`.trim() || 'Unnamed Patient';
                    patientSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading patients:", error);
            }
        }

        // Filter appointments based on search and filters
        function filterAppointments() {
            const searchTerm = searchInput.value.toLowerCase();
            const status = statusFilter.value;
            const date = dateFilter.value;
            
            filteredAppointments = appointments.filter(appointment => {
                const matchesSearch = !searchTerm || 
                    (appointment.patientName && appointment.patientName.toLowerCase().includes(searchTerm)) ||
                    (appointment.service && appointment.service.toLowerCase().includes(searchTerm)) ||
                    (appointment.notes && appointment.notes.toLowerCase().includes(searchTerm));
                
                const matchesStatus = status === 'all' || appointment.status === status;
                
                let matchesDate = true;
                if (date) {
                    const appointmentDate = appointment.date?.toDate();
                    if (appointmentDate) {
                        const selectedDate = new Date(date);
                        matchesDate = appointmentDate.toDateString() === selectedDate.toDateString();
                    } else {
                        matchesDate = false;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesDate;
            });
            
            currentPage = 1; // Reset to first page when filters change
            renderAppointments();
        }

        // Reset all filters
        function resetFilters() {
            searchInput.value = '';
            statusFilter.value = 'all';
            dateFilter.value = '';
            filterAppointments();
        }

        // Render appointments in the table
        function renderAppointments() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAppointments = filteredAppointments.slice(startIndex, endIndex);
            
            const appointmentList = document.getElementById('appointmentList');
            appointmentList.innerHTML = '';
            
            if (paginatedAppointments.length === 0) {
                appointmentList.innerHTML = '<div class="no-results">No appointments found</div>';
                updatePagination();
                return;
            }
            
            paginatedAppointments.forEach(appointment => {
                const row = document.createElement('div');
                row.className = 'appointment-row';
                
                const appointmentDate = appointment.date?.toDate() || new Date();
                const formattedDate = appointmentDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const formattedTime = appointmentDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <div class="appointment-id">${appointment.id.substring(0, 8)}</div>
                    <div class="appointment-patient">${appointment.patientName || 'N/A'}</div>
                    <div class="appointment-date">
                        <div>${formattedDate}</div>
                        <div class="text-muted">${formattedTime}</div>
                    </div>
                    <div class="appointment-service">${appointment.service || 'N/A'}</div>
                    <div class="appointment-status">
                        <span class="status-badge status-${appointment.status || 'scheduled'}">
                            ${(appointment.status || 'scheduled').charAt(0).toUpperCase() + (appointment.status || 'scheduled').slice(1)}
                        </span>
                    </div>
                    <div class="appointment-actions">
                        <button class="btn-icon btn-edit" data-id="${appointment.id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" data-id="${appointment.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                appointmentList.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appointmentId = e.currentTarget.getAttribute('data-id');
                    editAppointment(appointmentId);
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const appointmentId = e.currentTarget.getAttribute('data-id');
                    confirmDelete(appointmentId);
                });
            });
            
            updatePagination();
        }

        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(filteredAppointments.length / itemsPerPage);
            
            currentPageSpan.textContent = currentPage;
            totalPagesSpan.textContent = totalPages || 1;
            
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // Open modal to add new appointment
        function openAppointmentModal(appointment = null) {
            const modal = document.getElementById('appointmentModal');
            const form = document.getElementById('appointmentForm');
            
            if (appointment) {
                document.getElementById('modalTitle').textContent = 'Edit Appointment';
                document.getElementById('appointmentId').value = appointment.id;
                document.getElementById('patientSelect').value = appointment.patientId || '';
                
                const date = appointment.date?.toDate() || new Date();
                document.getElementById('appointmentDate').value = date.toISOString().split('T')[0];
                
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                document.getElementById('appointmentTime').value = `${hours}:${minutes}`;
                
                document.getElementById('serviceSelect').value = appointment.service || '';
                document.getElementById('statusSelect').value = appointment.status || 'scheduled';
                document.getElementById('appointmentNotes').value = appointment.notes || '';
            } else {
                document.getElementById('modalTitle').textContent = 'Add New Appointment';
                form.reset();
                
                // Set default date to today
                const today = new Date();
                document.getElementById('appointmentDate').value = today.toISOString().split('T')[0];
                
                // Set default time to next hour
                const nextHour = new Date();
                nextHour.setHours(nextHour.getHours() + 1, 0, 0, 0);
                const hours = nextHour.getHours().toString().padStart(2, '0');
                document.getElementById('appointmentTime').value = `${hours}:00`;
            }
            
            modal.style.display = 'flex';
        }

        // Save appointment to Firestore
        async function saveAppointment() {
            const form = document.getElementById('appointmentForm');
            const appointmentId = document.getElementById('appointmentId').value;
            const patientId = document.getElementById('patientSelect').value;
            const patientName = document.getElementById('patientSelect').options[document.getElementById('patientSelect').selectedIndex].text;
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const service = document.getElementById('serviceSelect').value;
            const status = document.getElementById('statusSelect').value;
            const notes = document.getElementById('appointmentNotes').value;
            
            // Combine date and time
            const [year, month, day] = date.split('-');
            const [hours, minutes] = time.split(':');
            const appointmentDate = new Date(year, month - 1, day, hours, minutes);
            
            try {
                const appointmentData = {
                    patientId,
                    patientName,
                    date: firebase.firestore.Timestamp.fromDate(appointmentDate),
                    service,
                    status,
                    notes,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: localStorage.getItem('loggedInUsername') || 'Employee'
                };
                
                if (appointmentId) {
                    // Update existing appointment
                    await db.collection('appointments').doc(appointmentId).update(appointmentData);
                    showNotification('Appointment updated successfully!', 'success');
                } else {
                    // Add new appointment
                    appointmentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    appointmentData.createdBy = localStorage.getItem('loggedInUsername') || 'Employee';
                    await db.collection('appointments').add(appointmentData);
                    showNotification('Appointment created successfully!', 'success');
                }
                
                // Close modal and refresh the list
                document.getElementById('appointmentModal').style.display = 'none';
                loadAppointments();
                
            } catch (error) {
                console.error("Error saving appointment:", error);
                showNotification('Error saving appointment. Please try again.', 'error');
            }
        }

        // Edit an existing appointment
        async function editAppointment(appointmentId) {
            try {
                const doc = await db.collection('appointments').doc(appointmentId).get();
                if (doc.exists) {
                    openAppointmentModal({
                        id: doc.id,
                        ...doc.data()
                    });
                } else {
                    showNotification('Appointment not found.', 'error');
                }
            } catch (error) {
                console.error("Error editing appointment:", error);
                showNotification('Error loading appointment details.', 'error');
            }
        }

        // Confirm before deleting an appointment
        function confirmDelete(appointmentId) {
            selectedAppointmentId = appointmentId;
            document.getElementById('confirmMessage').textContent = 'Are you sure you want to delete this appointment?';
            confirmActionBtn.textContent = 'Delete';
            confirmActionBtn.className = 'btn-danger';
            confirmModal.style.display = 'flex';
            
            // Set up confirmation action
            confirmActionBtn.onclick = deleteAppointment;
        }

        // Delete an appointment
        async function deleteAppointment() {
            if (!selectedAppointmentId) return;
            
            try {
                await db.collection('appointments').doc(selectedAppointmentId).delete();
                showNotification('Appointment deleted successfully!', 'success');
                confirmModal.style.display = 'none';
                loadAppointments();
            } catch (error) {
                console.error("Error deleting appointment:", error);
                showNotification('Error deleting appointment. Please try again.', 'error');
            } finally {
                selectedAppointmentId = null;
            }
        }

        // Show notification message
        function showNotification(message, type = 'info') {
            // You can implement a proper notification system here
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
